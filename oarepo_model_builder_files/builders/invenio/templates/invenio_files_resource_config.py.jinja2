import importlib_metadata
from flask_resources import HTTPJSONException, ResponseHandler, create_error_handler
from common.services.files.allowed_document_extensions import (
    InvalidFileExtensionException,
)

{{ vars.json_serializer.class|imports }}
{{ vars.resource_config|imports }}

class {{ vars.resource_config|class_header }}:
    """{{ vars.record.class|base_name }} resource config."""

    blueprint_name = '{{ vars.api_blueprint.alias }}'
    url_prefix = '{{ vars.resource_config.base_url }}'

    @property
    def response_handlers(self):
        entrypoint_response_handlers = {}
        for x in importlib_metadata.entry_points(group='invenio.{{ vars.module.qualified }}.response_handlers'):
            entrypoint_response_handlers.update(x.load())
        return {
            "application/vnd.inveniordm.v1+json": ResponseHandler({{vars.json_serializer.class|base_name}}()),
            **super().response_handlers,
            **entrypoint_response_handlers
        }

    error_handlers = {
        InvalidFileExtensionException: create_error_handler(
            lambda e: HTTPJSONException(
                code=415,
                description=str(e),
            )
        ),
    }

{{ vars.resource_config|extra_code }}